{% extends 'layout.html' %}
{% block title %}AI é…ç½®ç®¡ç† - {{ t('Prompt ç®¡ç†å™¨') }}{% endblock %}
{% block content %}
<div class="back-line">
  <a href="{{ url_for('index') }}" class="btn ghost back-btn" onclick="if (window.history.length > 1) { history.back(); return false; }">
   <i class="fas fa-arrow-left"></i>
   {{ t('è¿”å›') }}
  </a>
</div>

<div class="page-header">
  <h1 class="page-title">
    <i class="fas fa-robot"></i>
    AI é…ç½®ç®¡ç†
  </h1>
  <p class="page-subtitle">ç®¡ç†æ‚¨çš„AIæœåŠ¡é…ç½®ï¼Œæ”¯æŒå¤šç§AIæä¾›å•†</p>
</div>

<div class="settings-container">
  <!-- æ·»åŠ é…ç½®æŒ‰é’® -->
  <div class="section-content" style="margin-bottom: 20px;">
    <button class="btn primary" onclick="showAddConfigModal()">
      <i class="fas fa-plus"></i> æ·»åŠ æ–°é…ç½®
    </button>
  </div>

  <!-- é…ç½®åˆ—è¡¨ -->
  <div id="configsList" class="configs-grid">
    <!-- é…ç½®å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
  </div>
</div>

<!-- æ·»åŠ é…ç½®æ¨¡æ€æ¡† -->
<div id="addConfigModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>æ·»åŠ  AI é…ç½®</h3>
      <button class="btn-close" onclick="hideAddConfigModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="addConfigForm">
        <div class="form-group">
          <label for="configName">é…ç½®åç§° <span class="required">*</span></label>
          <input type="text" id="configName" name="name" required placeholder="è¯·è¾“å…¥é…ç½®åç§°">
        </div>

        <div class="form-row">
          <div class="form-group half">
            <label for="provider">AI æœåŠ¡å•†</label>
            <select id="provider" name="provider">
              <option value="openai">OpenAI</option>
              <option value="claude">Claude (Anthropic)</option>
              <option value="local">æœ¬åœ°æ¨¡å‹</option>
            </select>
          </div>
          <div class="form-group half">
            <label for="modelName">æ¨¡å‹åç§°</label>
            <input type="text" id="modelName" name="model_name" value="gpt-4" placeholder="gpt-4">
          </div>
        </div>

        <div class="form-group">
          <label for="apiKey">API å¯†é’¥ <span class="required">*</span></label>
          <div class="password-input-group">
            <input type="password" id="apiKey" name="api_key" required placeholder="è¯·è¾“å…¥APIå¯†é’¥">
            <button type="button" class="btn password-toggle" onclick="togglePasswordVisibility('apiKey')" title="æ˜¾ç¤º/éšè—å¯†é’¥">
              <i class="fas fa-eye" id="apiKey-icon"></i>
            </button>
          </div>
          <small class="form-help">å¯†é’¥å°†è¢«åŠ å¯†å­˜å‚¨</small>
        </div>

        <div class="form-group">
          <label for="apiUrl">API åœ°å€ï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" id="apiUrl" name="api_url" placeholder="è¯·è¾“å…¥APIåœ°å€">
          <small class="form-help">ç•™ç©ºä½¿ç”¨æœåŠ¡å•†é»˜è®¤åœ°å€</small>
        </div>

  
        <div class="form-row">
          <div class="form-group half">
            <label for="temperature">Temperature (0-1)</label>
            <input type="number" id="temperature" name="temperature" min="0" max="1" step="0.1" value="0.7">
          </div>
          <div class="form-group half">
            <label for="maxTokens">æœ€å¤§ Token æ•°</label>
            <input type="number" id="maxTokens" name="max_tokens" min="100" value="2000">
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="isActive" name="is_active" checked>
            <span>è®¾ä¸ºæ´»è·ƒé…ç½®</span>
          </label>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn ghost" onclick="hideAddConfigModal()">å–æ¶ˆ</button>
      <button class="btn primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
    </div>
  </div>
</div>

<!-- ç¼–è¾‘é…ç½®æ¨¡æ€æ¡† -->
<div id="editConfigModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ç¼–è¾‘ AI é…ç½®</h3>
      <button class="btn-close" onclick="hideEditConfigModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="editConfigForm">
        <input type="hidden" id="editConfigId" name="id">

        <div class="form-group">
          <label for="editConfigName">é…ç½®åç§° <span class="required">*</span></label>
          <input type="text" id="editConfigName" name="name" required>
        </div>

        <div class="form-row">
          <div class="form-group half">
            <label for="editProvider">AI æœåŠ¡å•†</label>
            <select id="editProvider" name="provider">
              <option value="openai">OpenAI</option>
              <option value="claude">Claude (Anthropic)</option>
              <option value="local">æœ¬åœ°æ¨¡å‹</option>
            </select>
          </div>
          <div class="form-group half">
            <label for="editModelName">æ¨¡å‹åç§°</label>
            <input type="text" id="editModelName" name="model_name">
          </div>
        </div>

        <div class="form-group">
          <label for="editApiKey">API å¯†é’¥</label>
          <div class="password-input-group">
            <input type="password" id="editApiKey" name="api_key" placeholder="ç•™ç©ºä¿æŒä¸å˜">
            <button type="button" class="btn password-toggle" onclick="togglePasswordVisibility('editApiKey')" title="æ˜¾ç¤º/éšè—å¯†é’¥">
              <i class="fas fa-eye" id="editApiKey-icon"></i>
            </button>
          </div>
          <small class="form-help">ç•™ç©ºä¿æŒåŸæœ‰å¯†é’¥ä¸å˜ï¼Œå¡«å†™æ–°å¯†é’¥å°†æ›¿æ¢åŸæœ‰å¯†é’¥</small>
        </div>

        <div class="form-group">
          <label for="editApiUrl">API åœ°å€ï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" id="editApiUrl" name="api_url" placeholder="è¯·è¾“å…¥APIåœ°å€">
          <small class="form-help">ç•™ç©ºä½¿ç”¨æœåŠ¡å•†é»˜è®¤åœ°å€</small>
        </div>

  
        <div class="form-row">
          <div class="form-group half">
            <label for="editTemperature">Temperature (0-1)</label>
            <input type="number" id="editTemperature" name="temperature" min="0" max="1" step="0.1">
          </div>
          <div class="form-group half">
            <label for="editMaxTokens">æœ€å¤§ Token æ•°</label>
            <input type="number" id="editMaxTokens" name="max_tokens" min="100">
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="editIsActive" name="is_active">
            <span>è®¾ä¸ºæ´»è·ƒé…ç½®</span>
          </label>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn ghost" onclick="hideEditConfigModal()">å–æ¶ˆ</button>
      <button class="btn primary" onclick="updateConfig()">æ›´æ–°é…ç½®</button>
    </div>
  </div>
</div>

<!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†å·²ç§»é™¤ - ç°åœ¨ç›´æ¥åˆ é™¤ -->

<style>
/* AIé…ç½®é¡µé¢ç‰¹å®šæ ·å¼ */
.configs-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.config-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.config-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px var(--shadow-hover);
}

.config-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
}

.config-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--fg);
  margin: 0;
}

.config-status {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
}

.config-status.active {
  background: var(--success);
  color: var(--text-on-success);
}

.config-status.inactive {
  background: var(--muted);
  color: var(--text-on-primary);
}

.config-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 15px;
}

.config-info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
}

.config-label {
  color: var(--muted);
  font-weight: 500;
}

.config-value {
  color: var(--fg);
  font-weight: 400;
}

.config-meta {
  font-size: 12px;
  color: var(--muted);
  margin-top: 10px;
}

.config-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.config-actions .btn {
  flex: 1;
  min-width: 80px;
  justify-content: center;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.empty-state i {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-state h3 {
  margin: 0 0 8px 0;
  color: var(--fg);
}

.empty-state p {
  margin: 0;
  font-size: 16px;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
}

.modal-content {
  background: var(--bg);
  border-radius: var(--radius-lg);
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 25px rgba(0, 0, 0, 0.25);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--border);
}

.modal-header h3 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  color: var(--fg);
}

.btn-close {
  background: none;
  border: none;
  font-size: 24px;
  color: var(--muted);
  cursor: pointer;
  padding: 0;
  line-height: 1;
}

.btn-close:hover {
  color: var(--fg);
}

.modal-body {
  padding: 24px;
}

.modal-footer {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  padding: 16px 24px 24px;
  border-top: 1px solid var(--border);
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.form-group.half {
  grid-column: span 1;
}

.required {
  color: var(--error);
}

.form-help {
  display: block;
  margin-top: 4px;
  font-size: 12px;
  color: var(--muted);
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-size: 14px;
}

.checkbox-label input[type="checkbox"] {
  margin: 0;
}

/* å¯†ç è¾“å…¥æ¡†ç»„æ ·å¼ */
.password-input-group {
  display: flex;
  gap: 8px;
  align-items: center;
}

.password-input-group input {
  flex: 1;
}

.password-toggle {
  padding: 8px 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  color: var(--fg);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
  height: 40px;
}

.password-toggle:hover {
  background: var(--bg-tertiary);
  border-color: var(--accent);
}

.password-toggle:active {
  transform: scale(0.95);
}

@media (max-width: 768px) {
  .configs-grid {
    grid-template-columns: 1fr;
  }

  .form-row {
    grid-template-columns: 1fr;
  }

  .modal-content {
    margin: 0;
    max-height: 100vh;
    border-radius: 0;
  }

  .config-actions {
    flex-direction: column;
  }
}
</style>

<script>
// ç‰ˆæœ¬æ§åˆ¶ - å¼ºåˆ¶åˆ·æ–°ç¼“å­˜
console.log('ğŸ”§ AIé…ç½®é¡µé¢å·²åŠ è½½ - v20251108-4 (ç›´æ¥åˆ é™¤ç‰ˆ)');

let configs = [];
let deleteConfigId = null;

// Toast é€šçŸ¥å‡½æ•°
function showToast(message, type = 'info') {
  console.log(`ğŸ”” [${type.toUpperCase()}] ${message}`);

  // åˆ›å»ºç®€å•çš„é€šçŸ¥å…ƒç´ 
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
    color: white;
    border-radius: 8px;
    z-index: 10000;
    font-size: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideIn 0.3s ease;
  `;
  toast.textContent = message;

  // æ·»åŠ åŠ¨ç”»æ ·å¼
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  `;
  document.head.appendChild(style);

  document.body.appendChild(toast);

  // 3ç§’åè‡ªåŠ¨ç§»é™¤
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

// åˆ‡æ¢å¯†ç æ˜¾ç¤º/éšè—
function togglePasswordVisibility(inputId) {
  const input = document.getElementById(inputId);
  const icon = document.getElementById(inputId + '-icon');

  if (input && icon) {
    if (input.type === 'password') {
      input.type = 'text';
      icon.classList.remove('fa-eye');
      icon.classList.add('fa-eye-slash');
    } else {
      input.type = 'password';
      icon.classList.remove('fa-eye-slash');
      icon.classList.add('fa-eye');
    }
  }
}

// é¡µé¢åŠ è½½æ—¶è·å–é…ç½®åˆ—è¡¨
document.addEventListener('DOMContentLoaded', function() {
  loadConfigs();
});

// åŠ è½½é…ç½®åˆ—è¡¨
async function loadConfigs() {
  console.log('ğŸ”„ å¼€å§‹åŠ è½½é…ç½®åˆ—è¡¨...');
  try {
    const response = await fetch('/api/ai-configs');
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    configs = await response.json();
    console.log('ğŸ“‹ é…ç½®åˆ—è¡¨åŠ è½½å®Œæˆ:', configs);
    renderConfigs();
    console.log('âœ… é…ç½®åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
  } catch (error) {
    console.error('âŒ åŠ è½½é…ç½®å¤±è´¥:', error);
    showToast('åŠ è½½é…ç½®å¤±è´¥', 'error');
  }
}

// æ¸²æŸ“é…ç½®åˆ—è¡¨
function renderConfigs() {
  const container = document.getElementById('configsList');
  console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“é…ç½®åˆ—è¡¨ï¼Œé…ç½®æ•°é‡:', configs.length);

  if (configs.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-robot"></i>
        <h3>æš‚æ—  AI é…ç½®</h3>
        <p>è¯·æ·»åŠ ä¸€ä¸ªé…ç½®å¼€å§‹ä½¿ç”¨AIä¼˜åŒ–åŠŸèƒ½</p>
      </div>
    `;
    console.log('âœ… æ¸²æŸ“ç©ºçŠ¶æ€å®Œæˆ');
    return;
  }

  const configsHtml = configs.map(config => `
    <div class="config-card">
      <div class="config-header">
        <h3 class="config-title">${config.name}</h3>
        <span class="config-status ${config.is_active ? 'active' : 'inactive'}">
          ${config.is_active ? 'æ´»è·ƒ' : 'æœªæ¿€æ´»'}
        </span>
      </div>

      <div class="config-info">
        <div class="config-info-item">
          <span class="config-label">æœåŠ¡å•†:</span>
          <span class="config-value">${config.provider.toUpperCase()}</span>
        </div>
        <div class="config-info-item">
          <span class="config-label">æ¨¡å‹:</span>
          <span class="config-value">${config.model_name}</span>
        </div>
        <div class="config-info-item">
          <span class="config-label">Temperature:</span>
          <span class="config-value">${config.temperature}</span>
        </div>
        <div class="config-info-item">
          <span class="config-label">æœ€å¤§Tokens:</span>
          <span class="config-value">${config.max_tokens}</span>
        </div>
      </div>

      <div class="config-meta">
        åˆ›å»ºæ—¶é—´: ${new Date(config.created_at).toLocaleString()}
      </div>

      <div class="config-actions">
        <button class="btn ghost" onclick="testConfig(${config.id})">
          <i class="fas fa-plug"></i> æµ‹è¯•
        </button>
        <button class="btn ghost" onclick="editConfig(${config.id})">
          <i class="fas fa-edit"></i> ç¼–è¾‘
        </button>
        <button class="btn danger" onclick="deleteConfig(${config.id})">
          <i class="fas fa-trash"></i> åˆ é™¤
        </button>
      </div>
    </div>
  `).join('');

  container.innerHTML = configsHtml;
  console.log('âœ… é…ç½®åˆ—è¡¨æ¸²æŸ“å®Œæˆï¼Œå®é™…DOMå…ƒç´ æ•°é‡:', container.children.length);
}

// æ˜¾ç¤ºæ·»åŠ é…ç½®æ¨¡æ€æ¡†
function showAddConfigModal() {
  document.getElementById('addConfigModal').style.display = 'flex';
  document.getElementById('addConfigForm').reset();
}

// éšè—æ·»åŠ é…ç½®æ¨¡æ€æ¡†
function hideAddConfigModal() {
  document.getElementById('addConfigModal').style.display = 'none';
}

// æ˜¾ç¤ºç¼–è¾‘é…ç½®æ¨¡æ€æ¡†
function showEditConfigModal() {
  console.log('æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†');
  const modal = document.getElementById('editConfigModal');
  if (modal) {
    modal.style.display = 'flex';
    console.log('æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
  } else {
    console.log('æœªæ‰¾åˆ°æ¨¡æ€æ¡†å…ƒç´ ');
  }
}

// éšè—ç¼–è¾‘é…ç½®æ¨¡æ€æ¡†
function hideEditConfigModal() {
  console.log('å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†');
  const modal = document.getElementById('editConfigModal');
  if (modal) {
    modal.style.display = 'none';
    console.log('æ¨¡æ€æ¡†å·²å…³é—­');
  } else {
    console.log('æœªæ‰¾åˆ°æ¨¡æ€æ¡†å…ƒç´ ');
  }
}

// æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
// åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†å‡½æ•°å·²ç§»é™¤ - ç°åœ¨ç›´æ¥åˆ é™¤

// ä¿å­˜é…ç½®
async function saveConfig() {
  const form = document.getElementById('addConfigForm');
  const formData = new FormData(form);

  const data = {
    name: formData.get('name'),
    provider: formData.get('provider') || 'openai',
    model_name: formData.get('model_name') || 'gpt-4',  // æ·»åŠ é»˜è®¤å€¼
    api_key: formData.get('api_key'),
    api_url: formData.get('api_url') || null,
    temperature: parseFloat(formData.get('temperature')) || 0.7,  // æ·»åŠ é»˜è®¤å€¼
    max_tokens: parseInt(formData.get('max_tokens')) || 2000,  // æ·»åŠ é»˜è®¤å€¼
    is_active: formData.has('is_active') ? 1 : 0
  };

  if (!data.name) {
    showToast('è¯·è¾“å…¥é…ç½®åç§°', 'error');
    return;
  }

  if (!data.api_key) {
    showToast('è¯·è¾“å…¥APIå¯†é’¥', 'error');
    return;
  }

  try {
    const response = await fetch('/api/ai-configs', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });

    if (response.ok) {
      const result = await response.json();
      showToast('é…ç½®åˆ›å»ºæˆåŠŸ', 'success');
      hideAddConfigModal();
      form.reset();
      loadConfigs();
    } else {
      const error = await response.json();
      showToast(error.error || 'åˆ›å»ºé…ç½®å¤±è´¥', 'error');
    }
  } catch (error) {
    console.error('åˆ›å»ºé…ç½®å¤±è´¥:', error);
    showToast('åˆ›å»ºé…ç½®å¤±è´¥', 'error');
  }
}

// ç¼–è¾‘é…ç½®
function editConfig(configId) {
  console.log('ç¼–è¾‘é…ç½®ID:', configId);
  const config = configs.find(c => c.id === configId);
  if (!config) {
    console.log('æœªæ‰¾åˆ°é…ç½®');
    return;
  }

  console.log('é…ç½®æ•°æ®:', config);

  document.getElementById('editConfigId').value = config.id;
  document.getElementById('editConfigName').value = config.name || '';
  document.getElementById('editProvider').value = config.provider || 'openai';
  document.getElementById('editModelName').value = config.model_name || 'gpt-4';
  document.getElementById('editApiUrl').value = config.api_url || '';
  document.getElementById('editTemperature').value = config.temperature || 0.7;
  document.getElementById('editMaxTokens').value = config.max_tokens || 2000;
  document.getElementById('editIsActive').checked = config.is_active === 1;
  // APIå¯†é’¥å­—æ®µä¸å¡«å……ï¼Œè®©ç”¨æˆ·é€‰æ‹©æ˜¯å¦æ›´æ–°

  console.log('è¡¨å•å·²å¡«å……ï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†');
  showEditConfigModal();
}

// æ›´æ–°é…ç½®
async function updateConfig() {
  console.log('=== å¼€å§‹æ›´æ–°é…ç½® ===');
  const configId = document.getElementById('editConfigId').value;
  console.log('é…ç½®ID:', configId);

  if (!configId) {
    console.error('é…ç½®IDä¸ºç©º');
    showToast('é…ç½®IDæ— æ•ˆ', 'error');
    return;
  }

  const form = document.getElementById('editConfigForm');
  if (!form) {
    console.error('æœªæ‰¾åˆ°ç¼–è¾‘è¡¨å•');
    showToast('è¡¨å•é”™è¯¯', 'error');
    return;
  }

  const formData = new FormData(form);
  const formDataObj = Object.fromEntries(formData);
  console.log('è¡¨å•æ•°æ®:', formDataObj);

  // ä¿®å¤APIåœ°å€å¤„ç†é€»è¾‘
  const apiUrlValue = formData.get('api_url');
  const data = {
    name: formData.get('name'),
    provider: formData.get('provider') || 'openai',
    model_name: formData.get('model_name') || 'gpt-4',  // æ·»åŠ é»˜è®¤å€¼
    api_key: formData.get('api_key') || undefined,
    api_url: apiUrlValue && apiUrlValue.trim() !== '' ? apiUrlValue.trim() : null,
    temperature: parseFloat(formData.get('temperature')) || 0.7,  // æ·»åŠ é»˜è®¤å€¼
    max_tokens: parseInt(formData.get('max_tokens')) || 2000,  // æ·»åŠ é»˜è®¤å€¼
    is_active: formData.has('is_active') ? 1 : 0
  };

  console.log('å‡†å¤‡å‘é€çš„æ•°æ®:', data);

  if (!data.name) {
    showToast('è¯·è¾“å…¥é…ç½®åç§°', 'error');
    return;
  }

  // å¦‚æœAPIå¯†é’¥å­—æ®µä¸ºç©ºï¼Œåˆ™ä»åŸæœ‰é…ç½®ä¸­ä¿æŒä¸å˜
  if (!data.api_key) {
    delete data.api_key; // åˆ é™¤å­—æ®µï¼Œåç«¯ä¼šä¿æŒåŸæœ‰å€¼
  }

  try {
    console.log('ğŸš€ å‘é€APIè¯·æ±‚...');
    const response = await fetch(`/api/ai-configs/${configId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });

    console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', response.status);

    if (response.ok) {
      const result = await response.json();
      console.log('âœ… æ›´æ–°APIå“åº”æˆåŠŸ:', result);
      showToast('é…ç½®æ›´æ–°æˆåŠŸ', 'success');

      // æˆåŠŸåå…³é—­æ¨¡æ€æ¡†
      console.log('ğŸ“¦ éšè—ç¼–è¾‘æ¨¡æ€æ¡†...');
      hideEditConfigModal();

      // ç„¶åé‡æ–°åŠ è½½æ•°æ®
      console.log('ğŸ”„ é‡æ–°åŠ è½½é…ç½®åˆ—è¡¨...');
      await loadConfigs();

      console.log('âœ… æ›´æ–°æµç¨‹å®Œæˆ');
    } else if (response.status === 404) {
      showToast('é…ç½®ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ·æ–°åˆ—è¡¨...', 'warning');
      hideEditConfigModal();
      await loadConfigs();
    } else if (response.status === 403) {
      const error = await response.json();
      console.error('âŒ æƒé™é”™è¯¯:', error);
      showToast('æ— æƒé™æ›´æ–°æ­¤é…ç½®', 'error');
      // æƒé™é”™è¯¯æ—¶ä¸å…³é—­æ¨¡æ€æ¡†ï¼Œè®©ç”¨æˆ·æ£€æŸ¥æƒé™
    } else {
      const error = await response.json();
      console.error('âŒ APIé”™è¯¯å“åº”:', error);
      showToast(error.error || 'æ›´æ–°é…ç½®å¤±è´¥', 'error');

      // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œé‡æ–°æ˜¾ç¤ºæ¨¡æ€æ¡†è®©ç”¨æˆ·ä¿®æ”¹
      console.log('ğŸ”„ é‡æ–°æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†...');
      showEditConfigModal();
    }
  } catch (error) {
    console.error('âŒ æ›´æ–°é…ç½®å¼‚å¸¸:', error);
    showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥', 'error');

    // ç½‘ç»œé”™è¯¯æ—¶ä¹Ÿé‡æ–°æ˜¾ç¤ºæ¨¡æ€æ¡†
    console.log('ğŸ”„ é‡æ–°æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†...');
    showEditConfigModal();
  }
}

// æµ‹è¯•é…ç½®
async function testConfig(configId) {
  try {
    showToast('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');

    const response = await fetch(`/api/ai-configs/${configId}/test`, {
      method: 'POST'
    });

    const result = await response.json();

    if (result.success) {
      showToast('è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
    } else {
      showToast(result.error || 'è¿æ¥æµ‹è¯•å¤±è´¥', 'error');
    }
  } catch (error) {
    console.error('æµ‹è¯•è¿æ¥å¤±è´¥:', error);
    showToast('æµ‹è¯•è¿æ¥å¤±è´¥', 'error');
  }
}

// åˆ é™¤é…ç½® - æ¢å¤ç¡®è®¤æœºåˆ¶
async function deleteConfig(configId) {
  const config = configs.find(c => c.id === configId);
  const configName = config ? config.name : 'æ­¤é…ç½®';

  console.log('ğŸ—‘ï¸ ç¡®è®¤åˆ é™¤é…ç½®:', configName, '(ID:', configId + ')');

  // æ¢å¤ç¡®è®¤æ­¥éª¤ - ä¸ä¸»é¡µé¢ä¿æŒä¸€è‡´
  if (!confirm(`ç¡®å®šè¦åˆ é™¤é…ç½®"${configName}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
    console.log('âŒ ç”¨æˆ·å–æ¶ˆåˆ é™¤');
    return;
  }

  console.log('ğŸš€ ç”¨æˆ·ç¡®è®¤åˆ é™¤ï¼Œå¼€å§‹æ‰§è¡Œ...');

  try {
    const response = await fetch(`/api/ai-configs/${configId}`, {
      method: 'DELETE'
    });

    console.log('ğŸ“¡ åˆ é™¤å“åº”çŠ¶æ€:', response.status);

    if (response.ok) {
      const result = await response.json();
      console.log('âœ… åˆ é™¤æˆåŠŸ:', result);
      showToast('é…ç½®åˆ é™¤æˆåŠŸ', 'success');

      // ä¼˜å…ˆé‡æ–°åŠ è½½æ•°æ®ï¼Œç¡®ä¿ä¸€è‡´æ€§ï¼ˆéµå¾ªé¡¹ç›®åŸæœ¬é€»è¾‘ï¼‰
      await loadConfigs();

    } else if (response.status === 404) {
      showToast('é…ç½®ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ·æ–°åˆ—è¡¨...', 'warning');
      await loadConfigs();
    } else if (response.status === 403) {
      showToast('æ— æƒé™åˆ é™¤æ­¤é…ç½®', 'error');
    } else {
      const error = await response.json();
      console.error('âŒ åˆ é™¤å¤±è´¥:', error);
      showToast(error.error || 'åˆ é™¤é…ç½®å¤±è´¥', 'error');
    }
  } catch (error) {
    console.error('âŒ åˆ é™¤é…ç½®å¤±è´¥:', error);
    showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥', 'error');
  }
}

// ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
document.getElementById('addConfigModal').addEventListener('click', function(e) {
  if (e.target === this) {
    hideAddConfigModal();
  }
});

document.getElementById('editConfigModal').addEventListener('click', function(e) {
  if (e.target === this) {
    hideEditConfigModal();
  }
});

// åˆ é™¤æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨å·²ç§»é™¤ - ç°åœ¨ç›´æ¥åˆ é™¤
</script>
{% endblock %}