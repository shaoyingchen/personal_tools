{% extends 'layout.html' %}
{% block title %}{{ t('è¯¦æƒ…') }} - {{ t('Prompt ç®¡ç†å™¨') }}{% endblock %}
{% block content %}
  <div class="page-header">
    <h1 class="page-title">
      <i class="fas fa-edit"></i>
      {% if prompt %}
        {{ prompt['name'] }}
      {% else %}
        {{ t('æç¤ºè¯ç¼–è¾‘') }}
      {% endif %}
    </h1>
  </div>

  <div class="prompt-editor-container">
    <div class="breadcrumb-nav">
      <a class="btn ghost" href="{{ url_for('index') }}">
        <i class="fas fa-arrow-left"></i> {{ t('è¿”å›åˆ—è¡¨') }}
      </a>
      {% if prompt %}
        <a class="btn ghost" href="{{ url_for('versions_page', prompt_id=prompt['id']) }}">
          <i class="fas fa-history"></i> {{ t('å†å²ç‰ˆæœ¬') }}
        </a>
        <button type="button" class="btn primary" onclick="openOptimizeModal()">
          <i class="fas fa-magic"></i> AI ä¼˜åŒ–
        </button>
      {% endif %}
    </div>

    <form method="post" class="prompt-form">
      <div class="form-sections">
        <!-- Basic Information Section -->
        <div class="form-section primary-section">
          <div class="section-header">
            <i class="fas fa-info-circle"></i>
            <h3>{{ t('åŸºæœ¬ä¿¡æ¯') }}</h3>
          </div>
          <div class="section-content">
            <div class="form-group">
              <label for="name">
                <i class="fas fa-heading"></i>
                {{ t('æç¤ºè¯åç§°') }}
                <span class="required">*</span>
              </label>
              <input type="text" id="name" name="name" value="{{ (prompt and prompt['name']) or '' }}" 
                     placeholder="{{ t('è¾“å…¥æç¤ºè¯çš„åç§°') }}" required />
              </div>

            <div class="form-group">
              <label for="content">
                <i class="fas fa-file-alt"></i>
                {{ t('æç¤ºè¯å†…å®¹') }}
                <span class="required">*</span>
              </label>
              <div class="textarea-wrapper">
                <textarea id="content" name="content" rows="16" 
                          placeholder="{{ t('åœ¨æ­¤è¾“å…¥æç¤ºè¯çš„å®Œæ•´å†…å®¹...') }}">{{ (current and current['content']) or '' }}</textarea>
                <div class="textarea-footer">
                  <div class="char-counter">0 {{ t('å­—ç¬¦') }}</div>
                  <div class="textarea-actions">
                    <button type="button" class="icon-btn" id="copyBtn" title="{{ t('å¤åˆ¶å†…å®¹') }}">
                      <i class="fas fa-copy"></i>
                    </button>
                    <button type="button" class="icon-btn" id="resizeBtn" title="{{ t('è‡ªåŠ¨è°ƒæ•´å¤§å°') }}">
                      <i class="fas fa-expand-alt"></i>
                    </button>
                    <button type="button" class="icon-btn" id="clearBtn" title="{{ t('æ¸…ç©ºå†…å®¹') }}">
                      <i class="fas fa-eraser"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Version Control Section -->
        <div class="form-section">
          <div class="section-header collapsible" onclick="toggleSection(this)">
            <i class="fas fa-cog"></i>
            <h3>{{ t('é«˜çº§è®¾ç½®') }}</h3>
            <i class="fas fa-chevron-down section-toggle"></i>
          </div>
          <div class="section-content">
            <div class="form-grid">
              <div class="form-group">
                <label for="source">
                  <i class="fas fa-link"></i>
                  {{ t('æ¥æº') }}
                </label>
                <input type="text" id="source" name="source" value="{{ (prompt and prompt['source']) or '' }}" 
                       placeholder="{{ t('æç¤ºè¯æ¥æº') }}" />
                </div>

              <div class="form-group">
                <label for="tags">
                  <i class="fas fa-tags"></i>
                  {{ t('æ ‡ç­¾') }}
                </label>
                <div class="tags-input-wrapper">
                  <input type="text" id="tags" name="tags" 
                         value="{% if prompt and prompt['tags'] %}{{ (prompt['tags']|loads)|join(', ') }}{% endif %}" 
                         placeholder="{{ t('æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”') }}" />
                  </div>
              </div>

              <div class="form-group">
                <label for="color">
                  <i class="fas fa-palette"></i>
                  {{ t('é¢œè‰²') }}
                </label>
                <div class="color-input">
                  <div class="color-input-row">
                    <div class="color-swatch-wrap">
                      <span class="color-swatch" id="colorSwatch" title="{{ t('é€‰æ‹©é¢œè‰²') }}" role="button" tabindex="0" aria-label="{{ t('é€‰æ‹©é¢œè‰²') }}"></span>
                      <input type="color" id="colorPicker" aria-label="{{ t('é€‰æ‹©é¢œè‰²') }}"
                             value="{{ (prompt and prompt['color']) or '#409eff' }}" />
                    </div>
                    <input type="text" id="color" name="color" value="{{ (prompt and prompt['color']) or '' }}" 
                           placeholder="{{ t('ä¾‹å¦‚ #409effï¼Œç•™ç©ºä¸è®¾ç½®') }}" />
                    <button type="button" class="icon-btn" id="colorClearBtn" title="{{ t('æ¸…é™¤é¢œè‰²') }}">
                      <i class="fas fa-eraser"></i>
                    </button>
                  </div>
                  <div class="input-help">{{ t('ç”¨äºé¦–é¡µå¡ç‰‡è¾¹æ¡†çš„ç»†å¾®å½©è‰²å¤–åœˆã€‚ç•™ç©ºåˆ™ä¸è®¾ç½®ã€‚') }}</div>
                </div>
              </div>

              <div class="form-group">
                <label for="notes">
                  <i class="fas fa-sticky-note"></i>
                  {{ t('å¤‡æ³¨') }}
                </label>
                <input type="text" id="notes" name="notes" value="{{ (prompt and prompt['notes']) or '' }}" 
                       placeholder="{{ t('è¡¥å……è¯´æ˜æˆ–ä½¿ç”¨æ³¨æ„äº‹é¡¹') }}" />
                  </div>
            </div>

            <div class="form-group" style="margin-top: var(--spacing-md);">
              <label class="checkbox-label">
                <input type="checkbox" name="require_password" value="1"
                       {% if prompt and prompt['require_password'] %}checked{% endif %}
                       {% if auth_mode != 'per' %}disabled{% endif %} />
                <span class="checkbox-custom"></span>
                <span class="checkbox-text">
                  <i class="fas fa-lock"></i>
                  {{ t('è¯¥æç¤ºè¯éœ€è¦å¯†ç è®¿é—®') }}
                </span>
              </label>
              {% if auth_mode == 'global' %}
                <div class="input-help">{{ t('å·²å¼€å¯å…¨å±€å¯†ç ï¼Œå•ä¸ªæç¤ºè¯çš„å¯†ç è®¾ç½®ä¸å†ç”Ÿæ•ˆã€‚') }}</div>
              {% elif auth_mode == 'off' %}
                <div class="input-help">{{ t('å½“å‰æœªå¯ç”¨â€œæŒ‡å®šæç¤ºè¯å¯†ç â€æ¨¡å¼ï¼Œæœ¬é¡¹æš‚ä¸ç”Ÿæ•ˆã€‚') }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <div class="actions-main">
          <button type="submit" class="btn primary">
            <i class="fas fa-check"></i>
            {% if prompt %}
              {{ t('ä¿å­˜ä¿®æ”¹') }}
            {% else %}
              {{ t('åˆ›å»ºæç¤ºè¯') }}
            {% endif %}
          </button>

          {% if prompt %}
          <button type="button" class="btn secondary" onclick="showOptimizeModal()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white;">
            <i class="fas fa-magic"></i> AI ä¼˜åŒ–
          </button>
          {% endif %}

          <a href="{{ url_for('index') }}" class="btn ghost">
            <i class="fas fa-arrow-left"></i>
            {{ t('è¿”å›åˆ—è¡¨') }}
          </a>
          {% if prompt %}
            <button type="button" class="btn ghost" onclick="triggerDelete()" style="border-color: var(--del); color: var(--del);">
              <i class="fas fa-trash"></i>
              {{ t('åˆ é™¤æç¤ºè¯') }}
            </button>
          {% endif %}
        </div>
        
        <div class="actions-version">
          <div class="version-checkbox">
            <label class="checkbox-label">
              <input type="checkbox" name="do_save_version" value="1" checked />
              <span class="checkbox-custom"></span>
              <span class="checkbox-text">
                <i class="fas fa-save"></i>
                {{ t('ä¿å­˜ä¸ºæ–°ç‰ˆæœ¬') }}
              </span>
            </label>
          </div>
          
          <div class="version-select-wrapper">
            <select id="bump_kind" name="bump_kind" class="version-select">
              <option value="patch" selected>
                {{ t('è¡¥ä¸ç‰ˆæœ¬ (+0.0.1)') }}
              </option>
              <option value="minor">
                {{ t('æ¬¡ç‰ˆæœ¬ (+0.1.0)') }}
              </option>
              <option value="major">
                {{ t('ä¸»ç‰ˆæœ¬ (+1.0.0)') }}
              </option>
            </select>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- AI Optimization Modal -->
  <div id="optimizeModal" class="modal">
    <div class="modal-content large">
      <div class="modal-header">
        <h3>ğŸ¤– AI æç¤ºè¯ä¼˜åŒ–</h3>
        <button class="modal-close" onclick="closeOptimizeModal()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="optimize-container">
          <div class="section">
            <h4>ğŸ¯ ä¼˜åŒ–è®¾ç½®</h4>

            <div class="form-group">
              <label>AI é…ç½®:</label>
              <select id="aiConfigSelect" class="form-control">
                <option value="">åŠ è½½ä¸­...</option>
              </select>
              <button type="button" class="btn small secondary" onclick="refreshAIConfigs()">
                <i class="fas fa-sync"></i> åˆ·æ–°
              </button>
            </div>

            <div class="form-group">
              <label>ä¼˜åŒ–è¦æ±‚:</label>
              <textarea id="optimizationPrompt" class="form-control" rows="4" placeholder="è¯·æè¿°ä½ å¸Œæœ›å¦‚ä½•ä¼˜åŒ–è¿™ä¸ªæç¤ºè¯ï¼Œä¾‹å¦‚ï¼š&#10;- è®©æç¤ºè¯æ›´åŠ ç®€æ´æ˜äº†&#10;- å¢åŠ æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯&#10;- ä¼˜åŒ–è¾“å‡ºæ ¼å¼&#10;- æé«˜å“åº”è´¨é‡">è¯·ä¼˜åŒ–è¿™ä¸ªæç¤ºè¯ï¼Œä½¿å…¶æ›´åŠ æœ‰æ•ˆå’Œæ¸…æ™°ã€‚</textarea>
            </div>

            <div class="form-actions">
              <button type="button" class="btn primary" onclick="startOptimization()">
                <i class="fas fa-magic"></i> å¼€å§‹ä¼˜åŒ–
              </button>
              <button type="button" class="btn ghost" onclick="closeOptimizeModal()">å–æ¶ˆ</button>
            </div>
          </div>

          <div class="section" id="optimizationProgress" style="display: none;">
            <h4>â³ ä¼˜åŒ–è¿›åº¦</h4>
            <div class="progress-container">
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
              </div>
              <p class="progress-text" id="progressText">æ­£åœ¨åˆ†ææç¤ºè¯...</p>
            </div>
          </div>

          <div class="section" id="optimizationResult" style="display: none;">
            <h4>âœ¨ ä¼˜åŒ–ç»“æœ</h4>

            <div class="result-tabs">
              <button class="tab-btn active" onclick="switchResultTab('optimized')">
                ä¼˜åŒ–åçš„ç‰ˆæœ¬
              </button>
              <button class="tab-btn" onclick="switchResultTab('comparison')">
                å¯¹æ¯”è§†å›¾
              </button>
            </div>

            <div class="tab-content" id="optimizedTab">
              <div class="result-header">
                <span class="success-badge">ä¼˜åŒ–å®Œæˆ</span>
                <small id="optimizationTime"></small>
              </div>
              <div class="result-content">
                <textarea id="optimizedContent" class="form-control" rows="15" readonly></textarea>
              </div>
              <div class="result-actions">
                <button type="button" class="btn primary" onclick="applyOptimizedContent()">
                  <i class="fas fa-check"></i> åº”ç”¨æ­¤ç‰ˆæœ¬
                </button>
                <button type="button" class="btn secondary" onclick="copyOptimizedContent()">
                  <i class="fas fa-copy"></i> å¤åˆ¶å†…å®¹
                </button>
                <button type="button" class="btn ghost" onclick="createNewOptimization()">
                  <i class="fas fa-redo"></i> é‡æ–°ä¼˜åŒ–
                </button>
              </div>
            </div>

            <div class="tab-content" id="comparisonTab" style="display: none;">
              <div class="comparison-container">
                <div class="comparison-side">
                  <h5>åŸå§‹ç‰ˆæœ¬</h5>
                  <div class="content-box" id="originalContent"></div>
                </div>
                <div class="comparison-side">
                  <h5>ä¼˜åŒ–ç‰ˆæœ¬</h5>
                  <div class="content-box" id="optimizedComparison"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-eye"></i> {{ t('æç¤ºè¯é¢„è§ˆ') }}</h3>
        <button class="modal-close" onclick="closePreview()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="preview-content">
          <h4 id="previewName"></h4>
          <div id="previewText"></div>
        </div>
      </div>
    </div>
  </div>

  {% if prompt %}
  <!-- Hidden delete form (separate from edit form to avoid nested forms) -->
  <form id="deleteForm" method="post" action="{{ url_for('delete_prompt', prompt_id=prompt['id']) }}"></form>
  {% endif %}


  <script>
    // i18n strings for this page
    const I18N = {
      SAVE_PROCESSING: {{ t('ä¿å­˜ä¸­...')|tojson }},
      CONFIRM_DELETE: {{ t('ç¡®å®šè¦åˆ é™¤è¯¥æç¤ºè¯åŠå…¶æ‰€æœ‰ç‰ˆæœ¬å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')|tojson }},
      CHAR: {{ t('å­—ç¬¦')|tojson }},
      ENTER_NAME: {{ t('è¯·è¾“å…¥æç¤ºè¯åç§°')|tojson }},
      ENTER_CONTENT: {{ t('è¯·è¾“å…¥æç¤ºè¯å†…å®¹')|tojson }},
      UNTITLED: {{ t('æœªå‘½åæç¤ºè¯')|tojson }},
      NO_CONTENT: {{ t('æ— å†…å®¹')|tojson }},
      AUTOSIZE_ON: {{ t('å·²å¼€å¯è‡ªåŠ¨è°ƒæ•´å¤§å°')|tojson }},
      AUTOSIZE_OFF: {{ t('è‡ªåŠ¨è°ƒæ•´å¤§å°')|tojson }},
      NO_COPY_SOURCE: {{ t('æ²¡æœ‰å†…å®¹å¯å¤åˆ¶')|tojson }},
      COPY_FAIL: {{ t('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶')|tojson }},
      CLEAR_CONFIRM: {{ t('ç¡®å®šè¦æ¸…ç©ºå†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')|tojson }}
    };
    // Auto-resize toggle state (default: off)
    let autoResizeEnabled = false;

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize form interactions
      initializeForm();
      
      // Textarea setup (no auto-resize by default)
      const textarea = document.getElementById('content');
      if (textarea) {
        updateCharCounter(textarea);
        
        textarea.addEventListener('input', () => {
          if (autoResizeEnabled) {
            autoResizeTextarea(textarea);
          }
          updateCharCounter(textarea);
        });
      }
      
      // Setup tag autocomplete
      setupTagAutocomplete();
      
      // Initialize collapsible sections
      initializeCollapsibleSections();
    });
    
    function initializeForm() {
      const form = document.querySelector('.prompt-form');
      const submitBtn = form.querySelector('button[type="submit"]');
      
      // Store original button text
      submitBtn.dataset.originalText = submitBtn.textContent.trim();
      
      // Form submission handler
      form.addEventListener('submit', (e) => {
        if (!validateForm()) {
          e.preventDefault();
          return;
        }
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span> ' + I18N.SAVE_PROCESSING;
        
        // Re-enable after 5 seconds (fallback)
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.innerHTML = submitBtn.dataset.originalText;
        }, 5000);
      });
    }

    // åˆ é™¤ç¡®è®¤ï¼šä»…ä¸€æ¬¡ç¡®è®¤
    function confirmDelete() {
      return confirm(I18N.CONFIRM_DELETE);
    }

    function triggerDelete() {
      if (confirmDelete()) {
        const f = document.getElementById('deleteForm');
        if (f) f.submit();
      }
    }
    
    function autoResizeTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.max(200, textarea.scrollHeight) + 'px';
    }
    
    function updateCharCounter(textarea) {
      const counter = document.querySelector('.char-counter');
      if (counter) {
        const length = textarea.value.length;
        counter.textContent = `${length} ` + I18N.CHAR;
        
        // Change color based on length
        if (length > 2000) {
          counter.style.color = 'var(--del)';
        } else if (length > 1000) {
          counter.style.color = 'var(--ins)';
        } else {
          counter.style.color = 'var(--muted)';
        }
      }
    }
    
    function setupTagAutocomplete() {
      const tagsInput = document.getElementById('tags');
      if (!tagsInput) return;
      
      let suggestions = [];
      
      // Fetch tag suggestions
      fetch('/api/tags')
        .then(r => r.json())
        .then(list => {
          suggestions = list;
          createAutocompleteDropdown(tagsInput, suggestions);
        })
        .catch(() => {});
    }
    
    function createAutocompleteDropdown(input, suggestions) {
      const dropdown = document.createElement('div');
      dropdown.className = 'tag-suggestions';
      dropdown.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 100;
        display: none;
        box-shadow: 0 4px 16px var(--shadow);
      `;
      
      input.parentNode.style.position = 'relative';
      input.parentNode.appendChild(dropdown);
      
      // Show/hide dropdown
      input.addEventListener('focus', () => showSuggestions(input, dropdown, suggestions));
      input.addEventListener('input', () => showSuggestions(input, dropdown, suggestions));
      input.addEventListener('blur', () => {
        setTimeout(() => dropdown.style.display = 'none', 200);
      });
    }
    
    function showSuggestions(input, dropdown, suggestions) {
      const val = input.value;
      const parts = val.replace(/ï¼Œ/g, ',').split(',');
      const lastPart = parts[parts.length - 1] || '';
      const lastTag = lastPart.trim();
      
      if (lastTag.length >= 1) {
        const matches = suggestions.filter(tag => 
          tag.toLowerCase().includes(lastTag.toLowerCase())
        ).slice(0, 5);
        
        if (matches.length > 0) {
          dropdown.innerHTML = matches.map(tag => 
            `<div class="tag-suggestion" style="padding: 8px 12px; cursor: pointer; transition: background 0.2s ease;" data-tag="${tag}">
              ${highlightMatch(tag, lastTag)}
            </div>`
          ).join('');
          
          dropdown.style.display = 'block';
          
          // Add click handlers
          dropdown.querySelectorAll('.tag-suggestion').forEach(item => {
            item.addEventListener('click', () => {
              const tag = item.dataset.tag;
              parts[parts.length - 1] = tag;
              input.value = parts.join(', ') + ', ';
              input.focus();
              dropdown.style.display = 'none';
            });
            
            item.addEventListener('mouseenter', () => {
              item.style.background = 'color-mix(in srgb, var(--primary) 10%, transparent)';
            });
            
            item.addEventListener('mouseleave', () => {
              item.style.background = '';
            });
          });
        } else {
          dropdown.style.display = 'none';
        }
      } else {
        dropdown.style.display = 'none';
      }
    }
    
    function highlightMatch(tag, search) {
      if (!search) return tag;
      const regex = new RegExp(`(${search})`, 'gi');
      return tag.replace(regex, '<strong style="color: var(--primary);">$1</strong>');
    }
    
    function initializeCollapsibleSections() {
      const collapsibles = document.querySelectorAll('.collapsible');
      collapsibles.forEach(collapsible => {
        // Start with collapsed state for non-primary sections
        if (!collapsible.closest('.primary-section')) {
          collapsible.classList.add('active');
          const content = collapsible.nextElementSibling;
          content.style.display = 'block';
        }
      });
    }
    
    function toggleSection(header) {
      header.classList.toggle('active');
      const content = header.nextElementSibling;
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        content.style.animation = 'fadeInUp 0.3s ease-out';
      } else {
        content.style.display = 'none';
      }
    }
    
    function validateForm() {
      const nameInput = document.getElementById('name');
      const contentInput = document.getElementById('content');
      
      let isValid = true;
      
      // Validate name
      if (!nameInput.value.trim()) {
        showFieldError(nameInput, I18N.ENTER_NAME);
        isValid = false;
      } else {
        clearFieldError(nameInput);
      }
      
      // Validate content
      if (!contentInput.value.trim()) {
        showFieldError(contentInput, I18N.ENTER_CONTENT);
        isValid = false;
      } else {
        clearFieldError(contentInput);
      }
      
      return isValid;
    }
    
    function showFieldError(field, message) {
      field.style.borderColor = 'var(--del)';
      field.style.animation = 'shake 0.5s ease-in-out';
      
      // Show error message
      let errorDiv = field.parentNode.querySelector('.field-error');
      if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.className = 'field-error';
        errorDiv.style.cssText = `
          color: var(--del);
          font-size: 12px;
          margin-top: 4px;
          font-weight: 500;
        `;
        field.parentNode.appendChild(errorDiv);
      }
      errorDiv.textContent = message;
      
      setTimeout(() => {
        field.style.animation = '';
      }, 500);
    }
    
    function clearFieldError(field) {
      field.style.borderColor = '';
      const errorDiv = field.parentNode.querySelector('.field-error');
      if (errorDiv) {
        errorDiv.remove();
      }
    }
    
    function previewPrompt() {
      const name = document.getElementById('name').value || I18N.UNTITLED;
      const content = document.getElementById('content').value || I18N.NO_CONTENT;
      
      document.getElementById('previewName').textContent = name;
      document.getElementById('previewText').textContent = content;
      document.getElementById('previewModal').style.display = 'block';
    }
    
    function closePreview() {
      document.getElementById('previewModal').style.display = 'none';
    }
    
    // Add shake animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
      }
      
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    `;
    document.head.appendChild(style);
    
    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
      const modal = document.getElementById('previewModal');
      if (e.target === modal) {
        closePreview();
      }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + S to save
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        document.querySelector('.prompt-form').dispatchEvent(new Event('submit'));
      }
      
      // Ctrl/Cmd + P to preview
      if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        previewPrompt();
      }
      
      // Escape to close modal
      if (e.key === 'Escape') {
        closePreview();
      }
    });
    
    // Button actions
    document.getElementById('resizeBtn')?.addEventListener('click', () => {
      const textarea = document.getElementById('content');
      autoResizeEnabled = !autoResizeEnabled;
      if (autoResizeEnabled) {
        autoResizeTextarea(textarea);
        document.getElementById('resizeBtn').title = I18N.AUTOSIZE_ON;
      } else {
        textarea.style.height = '';
        document.getElementById('resizeBtn').title = I18N.AUTOSIZE_OFF;
      }
    });
    
    document.getElementById('copyBtn')?.addEventListener('click', async () => {
      const textarea = document.getElementById('content');
      const content = textarea.value.trim();
      
      if (!content) {
        showFieldError(textarea, I18N.NO_COPY_SOURCE);
        return;
      }
      
      // Check if clipboard API is available
      if (!navigator.clipboard) {
        // Fallback to traditional method
        fallbackCopyTextToClipboard(content);
        return;
      }
      
      try {
        await navigator.clipboard.writeText(content);
        
        // Show success feedback
        const btn = document.getElementById('copyBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.style.background = 'var(--ins)';
        btn.style.color = 'var(--text-on-success)';
        
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.style.background = '';
          btn.style.color = '';
        }, 2000);
      } catch (err) {
        console.error('Clipboard API failed:', err);
        // Fallback to traditional method
        fallbackCopyTextToClipboard(content);
      }
    });
    
    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      
      // Avoid scrolling to bottom
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";
      
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          const btn = document.getElementById('copyBtn');
          const originalHTML = btn.innerHTML;
          btn.innerHTML = '<i class="fas fa-check"></i>';
          btn.style.background = 'var(--ins)';
          btn.style.color = 'var(--text-on-success)';
          
          setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.style.background = '';
            btn.style.color = '';
          }, 2000);
        } else {
          throw new Error('execCommand failed');
        }
      } catch (err) {
        console.error('Fallback copy failed:', err);
        alert(I18N.COPY_FAIL);
      }
      
      document.body.removeChild(textArea);
    }
    
    document.getElementById('clearBtn')?.addEventListener('click', () => {
      if (confirm(I18N.CLEAR_CONFIRM)) {
        document.getElementById('content').value = '';
        updateCharCounter(document.getElementById('content'));
        document.getElementById('content').focus();
      }
    });

    // AI ä¼˜åŒ–åŠŸèƒ½
    let currentOptimizationTaskId = null;
    let optimizationProgressInterval = null;

    // æ˜¾ç¤ºä¼˜åŒ–æ¨¡æ€æ¡†
    function showOptimizeModal() {
      document.getElementById('optimizeModal').style.display = 'flex';
      loadAIConfigs();
      resetOptimizationForm();
    }

    // æ‰“å¼€ä¼˜åŒ–æ¨¡æ€æ¡†
    function openOptimizeModal() {
      const modal = document.getElementById('optimizeModal');
      modal.classList.add('show');
      resetOptimizationForm();
      loadAIConfigs();
      // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
      document.body.style.overflow = 'hidden';
    }

    // å…³é—­ä¼˜åŒ–æ¨¡æ€æ¡†
    function closeOptimizeModal() {
      const modal = document.getElementById('optimizeModal');
      modal.classList.remove('show');
      if (optimizationProgressInterval) {
        clearInterval(optimizationProgressInterval);
        optimizationProgressInterval = null;
      }
      // æ¢å¤èƒŒæ™¯æ»šåŠ¨
      document.body.style.overflow = '';
    }

    // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('optimizeModal');
      if (e.target === modal) {
        closeOptimizeModal();
      }
    });

    // ESCé”®å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('optimizeModal');
        if (modal.classList.contains('show')) {
          closeOptimizeModal();
        }
      }
    });

    // é‡ç½®ä¼˜åŒ–è¡¨å•
    function resetOptimizationForm() {
      document.getElementById('optimizationProgress').style.display = 'none';
      document.getElementById('optimizationResult').style.display = 'none';
      document.getElementById('optimizationPrompt').value = 'è¯·ä¼˜åŒ–è¿™ä¸ªæç¤ºè¯ï¼Œä½¿å…¶æ›´åŠ æœ‰æ•ˆå’Œæ¸…æ™°ã€‚';
      currentOptimizationTaskId = null;
    }

    // åŠ è½½ AI é…ç½®
    async function loadAIConfigs() {
      try {
        const response = await fetch('/api/ai-configs');
        const configs = await response.json();

        const select = document.getElementById('aiConfigSelect');
        select.innerHTML = configs.map(config =>
          `<option value="${config.id}">${config.name} (${config.provider.toUpperCase()} - ${config.model_name})</option>`
        ).join('');

        if (configs.length > 0) {
          select.value = configs[0].id;
        }
      } catch (error) {
        console.error('åŠ è½½ AI é…ç½®å¤±è´¥:', error);
        document.getElementById('aiConfigSelect').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
      }
    }

    // åˆ·æ–° AI é…ç½®
    function refreshAIConfigs() {
      document.getElementById('aiConfigSelect').innerHTML = '<option value="">åˆ·æ–°ä¸­...</option>';
      loadAIConfigs();
    }

    // å¼€å§‹ä¼˜åŒ–
    async function startOptimization() {
      const configId = document.getElementById('aiConfigSelect').value;
      const optimizationPrompt = document.getElementById('optimizationPrompt').value;

      if (!configId) {
        alert('è¯·é€‰æ‹© AI é…ç½®');
        return;
      }

      if (!optimizationPrompt.trim()) {
        alert('è¯·è¾“å…¥ä¼˜åŒ–è¦æ±‚');
        return;
      }

      try {
        const response = await fetch(`/api/prompts/{{ prompt.id }}/optimize`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            ai_config_id: parseInt(configId),
            optimization_prompt: optimizationPrompt
          })
        });

        if (response.ok) {
          const result = await response.json();
          currentOptimizationTaskId = result.task_id;

          // æ˜¾ç¤ºè¿›åº¦
          document.getElementById('optimizationProgress').style.display = 'block';
          document.querySelector('.section:nth-child(1)').style.display = 'none';

          // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
          startProgressMonitoring();
        } else {
          const error = await response.json();
          alert(error.error || 'åˆ›å»ºä¼˜åŒ–ä»»åŠ¡å¤±è´¥');
        }
      } catch (error) {
        console.error('åˆ›å»ºä¼˜åŒ–ä»»åŠ¡å¤±è´¥:', error);
        alert('åˆ›å»ºä¼˜åŒ–ä»»åŠ¡å¤±è´¥');
      }
    }

    // å¼€å§‹è¿›åº¦ç›‘æ§
    function startProgressMonitoring() {
      let progress = 0;
      const progressSteps = [
        'æ­£åœ¨åˆ†ææç¤ºè¯...',
        'æ­£åœ¨å‘é€åˆ° AI æœåŠ¡...',
        'AI æ­£åœ¨å¤„ç†ä¼˜åŒ–è¯·æ±‚...',
        'æ­£åœ¨ç”Ÿæˆä¼˜åŒ–ç»“æœ...',
        'æ­£åœ¨ä¿å­˜ä¼˜åŒ–ç‰ˆæœ¬...'
      ];

      optimizationProgressInterval = setInterval(async () => {
        if (!currentOptimizationTaskId) return;

        try {
          const response = await fetch(`/api/optimization-tasks/${currentOptimizationTaskId}`);
          const task = await response.json();

          // æ›´æ–°è¿›åº¦
          progress = Math.min(progress + 20, 90);
          document.getElementById('progressFill').style.width = progress + '%';

          const stepIndex = Math.floor(progress / 20);
          document.getElementById('progressText').textContent = progressSteps[Math.min(stepIndex, progressSteps.length - 1)];

          if (task.status === 'completed') {
            // ä¼˜åŒ–å®Œæˆ
            clearInterval(optimizationProgressInterval);
            optimizationProgressInterval = null;

            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressText').textContent = 'ä¼˜åŒ–å®Œæˆï¼';

            setTimeout(() => {
              showOptimizationResult(task);
            }, 1000);

          } else if (task.status === 'failed') {
            // ä¼˜åŒ–å¤±è´¥
            clearInterval(optimizationProgressInterval);
            optimizationProgressInterval = null;

            alert('ä¼˜åŒ–å¤±è´¥: ' + (task.error_message || 'æœªçŸ¥é”™è¯¯'));
            resetOptimizationForm();
          }
        } catch (error) {
          console.error('è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
        }
      }, 2000);
    }

    // æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
    function showOptimizationResult(task) {
      document.getElementById('optimizationProgress').style.display = 'none';
      document.getElementById('optimizationResult').style.display = 'block';

      // è®¾ç½®ä¼˜åŒ–å†…å®¹
      document.getElementById('optimizedContent').value = task.result_content;
      document.getElementById('optimizedComparison').textContent = task.result_content;

      // è®¾ç½®åŸå§‹å†…å®¹
      const originalContent = document.getElementById('content').value;
      document.getElementById('originalContent').textContent = originalContent;

      // è®¾ç½®æ—¶é—´
      const now = new Date().toLocaleString();
      document.getElementById('optimizationTime').textContent = `å®Œæˆæ—¶é—´: ${now}`;
    }

    // åˆ‡æ¢ç»“æœæ ‡ç­¾
    function switchResultTab(tab) {
      const tabs = document.querySelectorAll('.tab-btn');
      const contents = document.querySelectorAll('.tab-content');

      tabs.forEach(t => t.classList.remove('active'));
      contents.forEach(c => c.style.display = 'none');

      if (tab === 'optimized') {
        tabs[0].classList.add('active');
        document.getElementById('optimizedTab').style.display = 'block';
      } else {
        tabs[1].classList.add('active');
        document.getElementById('comparisonTab').style.display = 'block';
      }
    }

    // åº”ç”¨ä¼˜åŒ–å†…å®¹
    async function applyOptimizedContent() {
      const optimizedContent = document.getElementById('optimizedContent').value;

      if (!currentOptimizationTaskId) {
        alert('ä¼˜åŒ–ä»»åŠ¡IDæ— æ•ˆ');
        return;
      }

      try {
        const response = await fetch(`/api/optimization-tasks/${currentOptimizationTaskId}/apply`, {
          method: 'POST'
        });

        if (response.ok) {
          // åº”ç”¨åˆ°ç¼–è¾‘å™¨
          document.getElementById('content').value = optimizedContent;
          updateCharCounter(document.getElementById('content'));

          // å…³é—­æ¨¡æ€æ¡†
          closeOptimizeModal();

          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          const successMsg = document.createElement('div');
          successMsg.className = 'alert alert-success';
          successMsg.textContent = 'ä¼˜åŒ–ç‰ˆæœ¬å·²åº”ç”¨ï¼Œå·²åˆ›å»ºæ–°ç‰ˆæœ¬è®°å½•ï¼';
          successMsg.style.position = 'fixed';
          successMsg.style.top = '20px';
          successMsg.style.right = '20px';
          successMsg.style.zIndex = '9999';
          document.body.appendChild(successMsg);

          setTimeout(() => {
            successMsg.remove();
          }, 5000);

          // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°ç‰ˆæœ¬
          setTimeout(() => {
            window.location.reload();
          }, 1000);

        } else {
          const error = await response.json();
          alert(error.error || 'åº”ç”¨ä¼˜åŒ–ç»“æœå¤±è´¥');
        }
      } catch (error) {
        console.error('åº”ç”¨ä¼˜åŒ–ç»“æœå¤±è´¥:', error);
        alert('åº”ç”¨ä¼˜åŒ–ç»“æœå¤±è´¥');
      }
    }

    // å¤åˆ¶ä¼˜åŒ–å†…å®¹
    function copyOptimizedContent() {
      const content = document.getElementById('optimizedContent').value;

      if (navigator.clipboard) {
        navigator.clipboard.writeText(content).then(() => {
          showMessage('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(() => {
          fallbackCopy(content);
        });
      } else {
        fallbackCopy(content);
      }
    }

    // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
    function fallbackCopy(content) {
      const textArea = document.createElement('textarea');
      textArea.value = content;
      document.body.appendChild(textArea);
      textArea.select();

      try {
        document.execCommand('copy');
        showMessage('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
      } catch (err) {
        showMessage('å¤åˆ¶å¤±è´¥', 'error');
      }

      document.body.removeChild(textArea);
    }

    // é‡æ–°ä¼˜åŒ–
    function createNewOptimization() {
      resetOptimizationForm();
      document.querySelector('.section:nth-child(1)').style.display = 'block';
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(message, type) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `alert alert-${type}`;
      msgDiv.textContent = message;
      msgDiv.style.position = 'fixed';
      msgDiv.style.top = '20px';
      msgDiv.style.right = '20px';
      msgDiv.style.zIndex = '9999';
      document.body.appendChild(msgDiv);

      setTimeout(() => {
        msgDiv.remove();
      }, 3000);
    }
  </script>
{% endblock %}
